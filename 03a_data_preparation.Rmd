# (PART) DATA PREPARATION {-}

# Creating Composite R Objects {#data-preparation}


```{block, type="tmbinfo", echo=T}
### Quick glimpse
Creating an object that joins the metadata, microbial abundance, and taxonomy data simplifies the downstream analyses. We will create a composite object containing lots of information needed to do any type of analysis we desire when exploring the **16S rRNA gene** or **metagenomics** sequencing data.
```

Let' get started


## Prerequisite
- Tidy metadata created in [PART 1](https://github.com/tmbuza/iMAP-part1/).
- Tidy microbial abundance table created in [PART 2](https://github.com/tmbuza/iMAP-part2/).
- Tidy taxonomy table created in [PART 2](https://github.com/tmbuza/iMAP-part2/).

## Import libraries and functions
```{r warning=FALSE, include=FALSE}
source("R/common.R")
library(tidyverse)
```

## Load preprocessed data
```{r}
cat("Metadata\n\n")
load("~/Dropbox/CDILLC/GIT_REPOS/iMAP_part1/RDataRDS/metadata_objects.RData", verbose = T)

cat("\nOtu and taxonomy tables\n\n")
load("~/Dropbox/CDILLC/GIT_REPOS/iMAP_part2/RDataRDS/otutaxonomy_objects.RData", verbose = T)

```

## Joining `mothur` output
```{r}
taxlevels <- c("kingdom", "phylum", "class", "order", "family", "genus" )

mo_metadata <-  mo_metadata %>% 
  select(sample_id, isolate) %>% 
  drop_na(isolate)

mo_otu_counts <- mo_otutable %>% 
  pivot_longer(-otu, names_to = "sample_id", values_to = "count") %>% 
  relocate(sample_id, .before = otu)

mo_taxonomy <- mo_taxonomy 
  
mo_composite <- inner_join(mo_metadata, mo_otu_counts, by = "sample_id") %>% 
  inner_join( ., mo_taxonomy, by = "otu") %>% 
  group_by(sample_id) %>% 
  mutate(rel_abund = count/sum(count)) %>% 
  ungroup() %>% 
  relocate(count, .before = rel_abund) 

cat("\nColumn names of the composite file\n")
colnames(mo_composite)

cat("\nDoes the relative abundance adds to 1? Must!\n")
mo_composite %>% 
  group_by(sample_id) %>% 
  summarise(total_re_abund = sum(rel_abund))

mo_composite_long <- mo_composite %>% 
  pivot_longer(cols = c(all_of(taxlevels), "otu"), names_to = "levels", values_to = "taxon") %>% 
  relocate(rel_abund, .after = taxon)


saveRDS(mo_composite, "RDataRDS/mo_composite.rds")
save(mo_composite_long, file = "RDataRDS/composite_long_objects.RData")
resave(mo_composite, mo_composite_long, file = "~/Dropbox/CDILLC/GIT_REPOS/smda-end2end/RDataRDS/saved_objects.RData")
```



## Joining `qiime2` output
```{r}
taxlevels <- c("kingdom", "phylum", "class", "order", "family", "genus" )

metadata <- q2_metadata %>% 
  select(sample_id = "sample-id", isolate) %>% 
  drop_na(isolate)

otu_counts <- q2_otutable %>% 
  pivot_longer(-feature, names_to = "sample_id", values_to = "count") %>% 
  relocate(sample_id, .before = feature)

taxonomy <- q2_taxonomy 
  
q2_composite <- inner_join(metadata, otu_counts, by = "sample_id") %>% 
  inner_join( ., taxonomy, by = "feature") %>% 
  group_by(sample_id) %>% 
  mutate(rel_abund = count/sum(count)) %>% 
  ungroup() %>% 
  relocate(count, .before = rel_abund)

cat("\nColumn names of the composite file\n")
colnames(mo_composite)

cat("\nDoes the relative abundance adds to 1? Must!\n")
q2_composite %>% 
  group_by(sample_id) %>% 
  summarise(total_re_abund = sum(rel_abund))

q2_composite_long <- q2_composite %>% 
  pivot_longer(cols = c(all_of(taxlevels), "feature"), names_to = "levels", values_to = "taxon") %>% 
  relocate(rel_abund, .after = taxon)

saveRDS(q2_composite, "RDataRDS/q2_composite.rds")
resave(q2_composite_long, file = "RDataRDS/composite_long_objects.RData")
resave(q2_composite, q2_composite_long, file = "~/Dropbox/CDILLC/GIT_REPOS/smda-end2end/RDataRDS/saved_objects.RData")
```


## Joining `metaphlan` output
- Here we create a composite object using default relative abundance output.
```{r}
taxlevels <- c("kingdom", "phylum", "class", "order", "family", "genus" )

metadata <- m3_metadata %>% 
  select(sample_id, platform) %>% 
  drop_na(platform)

m3_rel_otutable <- m3_otutable %>% 
  pivot_longer(-otu, names_to = "sample_id", values_to = "rel_abund") %>% 
  relocate(sample_id, .before = otu)

taxonomy <- m3_taxonomy

m3_rel_composite <- inner_join(metadata, m3_rel_otutable, by = "sample_id") %>% 
  inner_join( ., m3_taxonomy, by = "otu")

cat("\nColumn names of the composite file\n")
colnames(m3_rel_composite)

cat("\nDoes the relative abundance adds to 1? Must!\n")
m3_rel_composite %>% 
  group_by(sample_id) %>% 
  summarise(total_re_abund = round(sum(rel_abund)))

m3_rel_composite_long <- m3_rel_composite %>% 
  pivot_longer(cols = c(all_of(taxlevels), "otu"), names_to = "levels", values_to = "taxon") %>% 
  relocate(rel_abund, .after = taxon)


saveRDS(m3_rel_composite, "RDataRDS/m3_rel_composite.rds")
resave(m3_rel_composite_long, file = "RDataRDS/composite_long_objects.RData")
resave(m3_rel_composite, m3_rel_composite_long, file = "~/Dropbox/CDILLC/GIT_REPOS/smda-end2end/RDataRDS/saved_objects.RData")
```
### From `metaphlan` estimated read counts
- Here we create a composite object containing abundance based on the estimated mapped reads.

```{r}
taxlevels <- c("kingdom", "phylum", "class", "order", "family", "genus" )

metadata <- m3_metadata %>% 
  select(sample_id, platform) %>% 
  drop_na(platform)

m3_read_based_otutable <-  m3_read_counts_otutable %>% 
  pivot_longer(-otu, names_to = "sample_id", values_to = "count") %>% 
  relocate(sample_id, .before = otu) %>% 
  group_by(sample_id) %>% 
  mutate(rel_abund = count/sum(count)) %>% 
  ungroup() %>% 
  relocate(count, .before = rel_abund) 

taxonomy <- m3_taxonomy

m3_read_count_composite <- inner_join(metadata, m3_read_based_otutable, by = "sample_id") %>% 
  inner_join( ., m3_taxonomy, by = "otu")

cat("\nColumn names of the composite file\n")
colnames(m3_read_count_composite)

cat("\nDoes the relative abundance adds to 1? Must!\n")
m3_read_count_composite %>% 
  group_by(sample_id) %>% 
  summarise(total_re_abund = round(sum(rel_abund)))

m3_read_count_composite_long <- m3_read_count_composite %>% 
  pivot_longer(cols = c(all_of(taxlevels), "otu"), names_to = "levels", values_to = "taxon") %>% 
  relocate(rel_abund, .after = taxon)

saveRDS(m3_read_count_composite, "RDataRDS/m3_read_count_composite.rds")
resave(m3_read_count_composite_long, file = "RDataRDS/composite_long_objects.RData")
resave(m3_read_count_composite_long, file = "~/Dropbox/CDILLC/GIT_REPOS/smda-end2end/RDataRDS/saved_objects.RData")
```

## Saved objects in this section
```{r}
load("RDataRDS/composite_long_objects.RData", verbose = T)
```



# Creating Phyloseq Objects
## From `mothur` output
```{r}

```


## From `qiime2` output
```{r}

```


## From `metaphlan` output
```{r}

```


