# (PART) DATA PREPARATION {-}

# Tidying and merging Mothur Output

## Import libraries and functions
```{r warning=FALSE, include=FALSE}
source("R/common.R")

```

## Prerequisite
We need three files generated from previous analysis.

1. Metadata: generated in PART 1 user guide.
2. Mothur OTU tables: generated in PART 2 user guide.
3. Mothur conserved taxonomy tables generated in PART 2 user guide.


## Prepare tidy mothur otutable

```{r}
library(tidyverse)

mothur_otupath <- "~/Dropbox/CDILLC/GIT_REPOS/microbiome-part2/data/final.opti_mcc.shared"
shared_long <- read_tsv(mothur_otupath, show_col_types = FALSE) %>% 
  select(-label, -numOtus) %>% 
  rename(sample_id = Group) %>% 
  rename_all(tolower) %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  pivot_longer(-sample_id, names_to="otu", values_to="count") %>% 
  filter(count != 0)

head(shared_long)
```

## Prepare tidy mothur taxonomy table
```{r}  
taxlevels <- c("Domain", "Phylum", "Class", "Order", "Family", "Genus")

mothur_taxpath <- "~/Dropbox/CDILLC/GIT_REPOS/microbiome-part2/data/final.opti_mcc.0.03.cons.taxonomy"
cons_taxonomy <- read_tsv(mothur_taxpath, show_col_types = F) %>%
  rename_all(tolower) %>%
  select(otu, taxonomy) %>%
  mutate(otu = tolower(otu),
         taxonomy = str_replace_all(taxonomy, "\\(\\d+\\)", ""),
         taxonomy = str_replace(taxonomy, ";unclassified", "_unclassified"),
         taxonomy = str_replace_all(taxonomy, ";unclassified", ""),
         taxonomy = str_replace_all(taxonomy, ";$", ""),
         taxonomy = str_replace_all(taxonomy, ".*;", "")
         )
head(cons_taxonomy)
```

## Load preprocessed tidy metadata
```{r}
metapath <- "~/Dropbox/CDILLC/GIT_REPOS/microbiome-part1/RDataRDS/metadata.rds"
metadata <- readRDS(metapath) %>% 
  select(sample_id, ecosystem, isolate)

head(metadata)
```

## Merge mothur output
- We will merge the output at genus-level.
- OTU table or shared table
- Taxonomy
- Metadata

```{r}
mothur_genus_composite <- inner_join(shared_long, cons_taxonomy, by="otu") %>%
  group_by(sample_id, taxonomy) %>%
  summarize(count = sum(count), .groups="drop") %>%
  group_by(sample_id) %>%
  mutate(rel_abund = count / sum(count)) %>% 
  ungroup() %>%
  select(-count) %>%
  inner_join(metadata, ., by="sample_id")

head(mothur_genus_composite)

write_csv(mothur_genus_composite, "RDataRDS/mothur_genus_composite.csv" )
saveRDS(mothur_genus_composite, "RDataRDS/mothur_genus_composite.rds" )
```

<br>


# Tidying and merging QIIME2 output

## Import libraries and functions
```{r warning=FALSE, include=FALSE}
source("R/common.R")

```

## Prerequisite
W need three files as in Mothur:

- Feature table
- Taxonomy table
- Metadata table

## Prepare qiime2 feature table 

```{r}
q2_otupath <- "~/Dropbox/CDILLC/GIT_REPOS/microbiome-part2/data/q2-transformed-tables/feature-table.tsv"

q2_feature_long <- read_tsv(q2_otupath, skip = 1, show_col_types = F) %>%
  rename(otu = "#OTU ID") %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  pivot_longer(-otu, names_to="sample_id", values_to="count") %>%
  relocate(otu, .after = "sample_id") %>% 
  filter(count != 0)

head(q2_feature_long)
```

## Prepare qiime2 taxonomy 

```{r message=FALSE, warning=FALSE}
q2_taxpath <- "~/Dropbox/CDILLC/GIT_REPOS/microbiome-part2/data/q2-transformed-tables/taxonomy.tsv"
taxlevels <- c("kingdom", "phylum", "class", "order", "family", "genus", "species")

q2_taxonomy <- read_tsv(q2_taxpath, show_col_types = F) %>%
  rename_all(tolower) %>%
  rename(otu = "feature id") %>% 
  mutate(confidence = round(confidence, digits = 2),
         taxon = str_replace_all(taxon, "; s__$", ""),
         taxon = str_replace_all(taxon, "; g__$", ""),
         taxon = str_replace_all(taxon, "; f__$", ""),
         taxon = str_replace_all(taxon, "; o__$", ""),
         taxon = str_replace_all(taxon, "; c__$", ""),
         taxon = str_replace_all(taxon, "; p__$", ""),
         taxon = str_replace_all(taxon, "; k__$", ""),
         taxon = str_replace_all(taxon, "\\[|\\]", ""),
         ) %>% 
  separate(col = taxon, into = all_of(taxlevels), sep = "; ") %>%
  rename_all(tolower) %>% 
  select(otu, taxonomy = genus) %>% 
  drop_na()

head(q2_taxonomy)
```

## Merge qiime2 output
- We will merge data at genus-level.
- OTU table or shared table
- Taxonomy
- Metadata
```{r}
q2_genus_composite <- inner_join(q2_feature_long, q2_taxonomy, by="otu") %>%
  group_by(sample_id, taxonomy) %>%
  summarize(count = sum(count), .groups="drop") %>%
  group_by(sample_id) %>%
  mutate(rel_abund = count / sum(count)) %>% 
  ungroup() %>%
  select(-count) %>%
  inner_join(metadata, ., by="sample_id")

head(q2_genus_composite)

write_csv(q2_genus_composite, "RDataRDS/q2_genus_composite.csv" )
saveRDS(q2_genus_composite, "RDataRDS/q2_genus_composite.rds" )
```
